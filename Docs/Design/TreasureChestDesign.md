# Nodebreaker TD - 보물상자 시스템 상세 기획서

| 항목 | 내용 |
|------|------|
| 문서 버전 | 1.0 |
| 최종 수정 | 2026-02-15 |
| 작성자 | 기획팀장 (Game Designer) |
| 기준 문서 | GDD v2.0 섹션 3.5 |

---

## 1. 시스템 개요

### 1.1 보물상자란?

보물상자는 런 중에 획득하는 **일회성 버프 아이템**이다. 상자를 열면 3개의 선택지가 표시되고, 플레이어가 하나를 골라 즉시 적용한다. 버프는 **해당 런에서만 유효**하며, 죽으면 사라진다.

**핵심 설계 의도**: 로그라이크 게임에서 검증된 "3지선다" 시스템을 도입하여, 매 런마다 다른 경험을 제공하고 "이번 런은 운이 좋아서 더 멀리 갔다"라는 쾌감을 만든다. 영구 성장(스킬 트리)이 "확실한 성장"이라면, 보물상자는 "운에 의한 폭발적 성장"이다.

### 1.2 Nodebuster 레퍼런스 대비 차별점

| 요소 | Nodebuster | Nodebreaker TD |
|------|-----------|---------------|
| 획득 방식 | 웨이브 클리어 보상 | 몬스터 드랍 + 보스 확정 + 웨이브 보상 |
| 선택지 수 | 3개 | 3개 (동일) |
| 버프 영속성 | 런 내 | 런 내 (동일) |
| 상자 등급 | 없음 | 일반 / 희귀 2등급 |
| 중복 | 중복 없음 | 동일 버프 중첩 가능 (최대 3중첩) |

---

## 2. 보물상자 드랍 설계

### 2.1 드랍 소스별 확률

| 드랍 소스 | 일반 상자 확률 | 희귀 상자 확률 | 비고 |
|----------|-------------|-------------|------|
| 일반 Node 처치 | 3% | 0.3% | 기본 확률. 매 처치 시 독립 판정 |
| 웨이브 클리어 보상 | 20% | 5% | 웨이브 번호가 높을수록 확률 증가 (+3%/웨이브) |
| 보스 처치 | 100% (확정) | 50% | 보스는 반드시 상자 1개 + 50% 확률로 희귀 |
| 콤보 보너스 (10콤보+) | 8% | 1% | 10연속 처치 이상 시 추가 판정 |

### 2.2 웨이브별 드랍 확률 보정

웨이브가 진행될수록 상자 드랍 확률이 소폭 증가한다.

| 웨이브 | 일반 Node 기본 확률 | 웨이브 클리어 확률 |
|--------|-------------------|-----------------|
| W1 | 3% | 20% |
| W2 | 3.5% | 23% |
| W3 | 4% | 26% |
| W4 | 4.5% | 29% |
| W5 | 5% | 32% |
| W10 | 7.5% | 47% |
| W15 | 10% | 62% |
| W20 | 12.5% | 77% |

공식: `기본확률 * (1 + 웨이브번호 * 0.1)`

### 2.3 한 런당 평균 상자 획득 수

#### Stage 1 (5웨이브, 초반)

| 시나리오 | 처치 Node 수 | 일반 상자 (기대값) | 희귀 상자 (기대값) | 합계 |
|---------|-----------|----------------|----------------|------|
| 첫 런 (W2에서 사망) | ~7 | 0.22 | 0.02 | **~0.2개** |
| 10회차 (W4까지) | ~25 | 1.0 | 0.1 | **~1.1개** |
| 클리어 런 | ~51 | 2.2 + 보스 1 | 0.3 + 보스 0.5 | **~4.0개** |

#### Stage 5 (10웨이브, 중반)

| 시나리오 | 처치 Node 수 | 상자 합계 (기대값) |
|---------|-----------|-----------------|
| 절반 진행 (W5) | ~80 | **~4.5개** |
| 클리어 | ~200 | **~10개** |

#### Stage 10 (20웨이브, 최종)

| 시나리오 | 처치 Node 수 | 상자 합계 (기대값) |
|---------|-----------|-----------------|
| 클리어 | ~500+ | **~25개** |

### 2.4 드랍 확률 설계 근거

- **초반(W1~2 사망)**: 상자 0~1개. "상자가 뭔지 맛보기"만 경험
- **중반(W3~4 도달)**: 런당 1~2개. "상자 버프로 더 오래 버텼다!" 체감 시작
- **클리어 런**: 3~4개. 매 웨이브 사이에 1개씩 열며 빌드 구성
- **후반 스테이지 클리어**: 10~25개. 버프가 중첩되며 폭발적 파워 체감

핵심 원칙: **상자는 "보너스"이지 "필수"가 아니다.** 상자 없이도 영구 성장만으로 클리어 가능해야 하지만, 상자가 좋으면 1~2런 더 빨리 클리어할 수 있는 정도.

---

## 3. 선택지 풀 설계

### 3.1 일반 상자 선택지 (총 12종)

일반 상자에서 나올 수 있는 버프. 3개가 랜덤으로 표시되며 1개를 선택한다.

#### 공격 계열 (4종)

| ID | 이름 | 효과 | 중첩 시 | 설계 의도 |
|----|------|------|---------|----------|
| C01 | 날카로운 화살촉 | 타워 데미지 +15% | 15%/30%/45% | 범용 공격력 증가 |
| C02 | 신속의 룬 | 타워 공격속도 +10% | 10%/20%/30% | DPS 간접 증가 |
| C03 | 사거리 확장 | 타워 사거리 +0.5 | 0.5/1.0/1.5 | 더 먼 적 사전 타격 |
| C04 | 집중 사격 | 10초간 첫 타격 데미지 2배 | 효과 갱신 | 새 웨이브 시작 시 폭딜 |

#### 방어 계열 (3종)

| ID | 이름 | 효과 | 중첩 시 | 설계 의도 |
|----|------|------|---------|----------|
| C05 | 보강된 성벽 | 기지 HP +10 | +10/+20/+30 | 생존력 직접 증가 |
| C06 | 재생의 오라 | 기지 HP 초당 1 회복 | 1/2/3 | 장기전 유리 |
| C07 | 최후의 보루 | HP 25% 이하 시 모든 타워 데미지 +50% | 50%/75%/100% | 역전 드라마 연출 |

#### 경제 계열 (3종)

| ID | 이름 | 효과 | 중첩 시 | 설계 의도 |
|----|------|------|---------|----------|
| C08 | 황금빛 수확 | Bit 드롭 +20% | 20%/40%/60% | 인게임 경제 부스트 |
| C09 | 행운의 동전 | Node 처치 시 5% 확률로 Bit 5배 드롭 | 5%/10%/15% | 랜덤 잭팟 쾌감 |
| C10 | 할인 쿠폰 | 타워 배치/업그레이드 비용 -15% | 15%/25%/35% | 더 빠른 타워 확장 |

#### 유틸리티 계열 (2종)

| ID | 이름 | 효과 | 중첩 시 | 설계 의도 |
|----|------|------|---------|----------|
| C11 | 감속 필드 | 모든 Node 이동속도 -10% | 10%/18%/25% | 전체 Node 감속 |
| C12 | 스폰 지연 | 다음 웨이브 스폰 간격 +0.3초 | 0.3/0.5/0.7 | 준비 시간 확보 |

### 3.2 희귀 상자 선택지 (총 8종)

희귀 상자만의 전용 선택지. 일반 선택지보다 확실히 강력하다.

| ID | 이름 | 효과 | 중첩 시 | 설계 의도 |
|----|------|------|---------|----------|
| R01 | 치명타 마스터 | 크리티컬 확률 +10%, 크리티컬 데미지 +50% | 확률/데미지 중첩 | 영구 크리티컬 미해금 시 맛보기 |
| R02 | 이중 사격 | 30% 확률로 투사체 2발 발사 | 30%/50%/70% | 시각적 화려함 + 체감 DPS 대폭 증가 |
| R03 | 체인 라이트닝 | 타워 공격에 20% 확률로 체인 1회 추가 | 확률 중첩 | Lightning 미해금 시 맛보기 |
| R04 | 불사의 기지 | 기지 HP 0일 때 1회 부활 (HP 50% 회복) | 부활 횟수 중첩 | "한 번 더" 기회. 강력한 안전망 |
| R05 | Bit 폭풍 | 즉시 현재 보유 Bit의 50% 추가 획득 | 50%/50%/50% | 즉각적인 경제 부스트 |
| R06 | 타워 분신 | 랜덤 배치된 타워 1기를 복제 (같은 레벨) | 복제 횟수 | 무료 타워 1기 = 큰 가치 |
| R07 | 약점 노출 | 모든 Node 방어력 -3, 받는 데미지 +10% | 방어력/데미지 증가 중첩 | Shield Node 대응, 후반 필수급 |
| R08 | 시간 가속 | 8초간 타워 공격속도 3배 (웨이브 시작 시 자동 발동) | 지속시간 +4초씩 | 웨이브 초반 폭딜로 물량 정리 |

### 3.3 선택지 가중치 시스템

3개의 선택지를 뽑을 때, 완전 랜덤이 아니라 가중치를 적용한다.

#### 가중치 규칙

1. **중복 방지 (같은 카테고리)**: 같은 카테고리에서 2개 이상 나오지 않음 (공격/방어/경제/유틸)
2. **현재 상황 반영**:
   - 기지 HP < 50%이면 방어 계열 가중치 x2
   - 보유 Bit < 타워 1기 비용이면 경제 계열 가중치 x1.5
   - 타워 3기 이상 배치 시 공격 계열 가중치 x1.5
3. **이미 보유한 버프 중첩 제한**: 같은 버프가 이미 2중첩이면 해당 선택지 제외 (3중첩까지만)
4. **보장 규칙**: 최소 1개는 공격 계열이 포함되도록 (빈 선택지 방지)

### 3.4 선택지 밸런스 분석

**일반 상자 선택지 간 비교 (DPS 기여도 환산)**

| 선택지 | Arrow Lv1 기준 DPS 기여 | 평가 |
|--------|---------------------|------|
| 날카로운 화살촉 (+15% DMG) | +1.5 DPS | 기준 |
| 신속의 룬 (+10% 공속) | +1.0 DPS | 약간 낮지만 전 타워 적용 |
| 사거리 확장 (+0.5) | 간접 (선타 시간 확보) | 유틸리티 |
| 집중 사격 (첫 타격 2배) | 상황적. 고레벨 타워일수록 강함 | 상위 호환 잠재력 |
| 보강된 성벽 (+10 HP) | DPS 0, 생존 +50% (기지 HP 20 기준) | 초반 필수급 |
| 황금빛 수확 (+20% Bit) | DPS 0, 경제 +20% | 장기 투자 |
| 감속 필드 (-10% 속도) | 간접 DPS +11% (Node 통과 시간 증가) | 유틸리티 |

**밸런스 의도**: 어떤 선택지를 골라도 "나쁜 선택"이 아닌 수준. 상황에 따라 최적이 달라진다.
- HP가 낮으면 보강된 성벽이 최적
- 타워가 많으면 날카로운 화살촉이 최적 (전체 적용)
- 자원이 부족하면 황금빛 수확이 최적
- **"항상 이것만 고르면 됨"이 없어야 한다.**

---

## 4. 중첩 시스템

### 4.1 중첩 규칙

- 같은 버프는 최대 **3중첩**까지 가능
- 중첩 시 효과는 **합산** (곱연산 아님)
- 3중첩 달성 시 해당 선택지는 선택지 풀에서 제거 (다른 버프 등장 확률 증가)

### 4.2 중첩 효과 예시

```
날카로운 화살촉:
  1중첩: 데미지 +15%
  2중첩: 데미지 +30%
  3중첩: 데미지 +45% (최대)

불사의 기지 (희귀):
  1중첩: 부활 1회
  2중첩: 부활 2회
  3중첩: 부활 3회 (최대)
```

### 4.3 중첩 밸런스

3중첩 시 효과가 너무 강하지 않도록 설계:
- 일반 3중첩 최대 효과: DPS 약 +45% or 생존 +150%
- 희귀 3중첩 최대 효과: DPS 약 +80% or 부활 3회
- **영구 업그레이드 1개(+10% DPS)와 비교**: 일반 1중첩(+15%) > 영구 1개. 그러나 일시적이므로 균형.

---

## 5. 런 내 영향도 분석

### 5.1 보물상자 버프의 전체 DPS 기여도

**Stage 1 클리어 런 (상자 ~4개, 일반 3 + 희귀 1 기대)**

| 시나리오 | 총 DPS 보정 | 영구 업그레이드 환산 | 런 스킵 효과 |
|---------|-----------|-----------------|-----------|
| 운 나쁨 (방어+경제 위주) | +0~10% DPS, +20 HP | 영구 1레벨 수준 | 0~1런 단축 |
| 평균 (공격 1~2 + 방어/경제) | +20~35% DPS | 영구 2~3레벨 수준 | 1~2런 단축 |
| 운 좋음 (공격 위주 + 희귀) | +50~70% DPS | 영구 5~6레벨 수준 | 2~4런 단축 |
| 극대운 (희귀 3중첩 등) | +100%+ DPS | 영구 8~10레벨 수준 | 3~5런 단축 |

### 5.2 설계 의도: "운 좋으면 스킵할 수 있는" 정도

- **평균 시나리오**: 영구 성장 2~3레벨 분량 = "이번 런은 좀 더 편하다" 정도
- **극대운 시나리오**: 영구 성장 8~10레벨 분량 = "이번에 한 스테이지 더 갈 수 있을지도?" 수준
- **핵심**: 상자만으로 스테이지를 스킵할 수는 없다. 영구 성장이 없으면 결국 벽에 부딪힘
- 상자는 "운 좋은 런"을 만들어 재미를 더하지만, 장기적으로는 영구 성장이 핵심

### 5.3 보물상자와 "한 판만 더" 심리

```
시나리오 A: 상자 없이 W3에서 사망
  -> "다음엔 업그레이드 하나 더 찍고 가면..."  (확실한 성장 동기)

시나리오 B: 상자 덕에 W4까지 갔으나 아깝게 사망
  -> "아 상자 운이 좋으면 클리어했을 텐데!"  (운에 대한 기대)

시나리오 C: 좋은 상자를 뽑아서 예상보다 먼 웨이브 도달
  -> "이번 런 대박이다! 좀 더 가보자!"  (현재 런의 몰입)
```

세 시나리오 모두 "한 판만 더"로 귀결된다.

---

## 6. 보물상자 UX/연출 설계

### 6.1 상자 드랍 연출

```
Node 처치 시 상자 드랍:
1. Node 파괴 이펙트 위에 상자 아이콘이 "뿅" 하고 등장
2. 상자가 기지 쪽으로 자동 흡수 (0.5초)
3. 화면 하단에 "보물상자 +1" 알림
4. 게임 일시정지 없음 (인벤토리에 저장)
```

### 6.2 상자 열기 UX

```
하단 인벤토리 옆 상자 아이콘 클릭:
1. 게임 일시정지 (단, 3배속 중이면 1배속으로 전환)
2. 상자 열기 애니메이션 (0.8초)
3. 3개 선택지가 카드 형태로 펼쳐짐
4. 각 카드: 이름 + 효과 설명 + 등급 테두리 색상
5. 카드 클릭 -> 선택 -> 버프 적용 이펙트 -> 게임 재개

카드 등급 테두리:
- 일반 상자: 은색 테두리
- 희귀 상자: 금색 테두리 + 반짝임 이펙트
```

### 6.3 상자 타이밍

- 상자는 획득 즉시 열 필요 없음. 인벤토리에 쌓임 (최대 5개)
- 플레이어가 원하는 타이밍에 열 수 있음
- **자동 열기 옵션**: 설정에서 "상자 자동 열기" ON/OFF (방치형 유저 배려)
- 자동 열기 시: 가중치가 가장 높은 선택지 자동 선택 (공격 > 방어 > 경제 > 유틸)
- 미개봉 상자 5개 초과 시 가장 오래된 상자 자동 열기 (자동 선택)

---

## 7. 보물상자 데이터 구조 (SO 설계)

### 7.1 TreasureChestData SO

```csharp
[CreateAssetMenu(fileName = "TreasureChest_", menuName = "Game/Treasure Chest")]
public class TreasureChestData : ScriptableObject
{
    public string chestId;
    public string chestName;
    public ChestRarity rarity;          // Normal, Rare
    public int choiceCount = 3;         // 선택지 수 (항상 3)
    public List<ChestRewardData> rewardPool;  // 가능한 선택지 풀
}
```

### 7.2 ChestRewardData SO

```csharp
[CreateAssetMenu(fileName = "ChestReward_", menuName = "Game/Chest Reward")]
public class ChestRewardData : ScriptableObject
{
    public string rewardId;
    public string rewardName;
    public string description;
    public Sprite icon;
    public RewardCategory category;     // Attack, Defense, Economy, Utility
    public ChestRarity minRarity;       // 이 선택지가 등장 가능한 최소 상자 등급

    [Header("효과")]
    public BuffType buffType;           // DamageBoost, SpeedBoost, HpRestore, etc.
    public float value;                 // 효과 수치 (15 = +15%)
    public int maxStack = 3;            // 최대 중첩 수

    [Header("가중치")]
    public float baseWeight = 1.0f;     // 기본 등장 가중치
}
```

---

## 8. 구현 우선순위

| 우선순위 | 항목 | 스프린트 |
|---------|------|---------|
| P0 | 상자 드랍 시스템 (Node 처치 시 확률 판정) | Sprint 4 |
| P0 | 3지선다 UI (카드 선택 화면) | Sprint 4 |
| P0 | 일반 상자 선택지 6종 (공격3 + 방어2 + 경제1) | Sprint 4 |
| P1 | 나머지 일반 선택지 6종 | Sprint 5 |
| P1 | 희귀 상자 + 전용 선택지 8종 | Sprint 5 |
| P1 | 중첩 시스템 | Sprint 5 |
| P2 | 가중치 시스템 (상황 기반) | Sprint 6 |
| P2 | 자동 열기 옵션 | Sprint 6 |
| P2 | 보스 확정 드랍 연출 | Sprint 6 |

---

## 9. 밸런스 검증 체크리스트

- [ ] Stage 1 첫 런(W2 사망)에서 상자 0~1개 획득하는지
- [ ] Stage 1 클리어 런에서 상자 3~5개 획득하는지
- [ ] 일반 상자 선택지 중 특정 1개가 압도적으로 선택되지 않는지 (목표: 각 선택지 선택률 편차 +/-10%)
- [ ] 희귀 상자 버프로 인한 DPS 증가가 영구 업그레이드 10레벨 미만인지
- [ ] 극대운 시나리오에서도 스테이지 스킵이 불가능한지 (영구 성장 필수)
- [ ] 3중첩 상한이 게임을 깨트리지 않는지 (최대 +45% DPS는 영구 x1.5 수준)
- [ ] 보스 확정 드랍이 "보스까지 가야 하는" 동기를 충분히 부여하는지

---

*이 문서는 GDD v2.0과 연동되며, 프로토타입 테스트 결과에 따라 수치가 조정됩니다.*
